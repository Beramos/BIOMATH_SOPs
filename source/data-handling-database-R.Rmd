---
title: "Read data from INBO database (SQL Server) with R(ODBC)"
maintainer: "Stijn Van Hoey"
date: "February 3, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

To query data from a SQL database you can already access using MSAccess, the link can be made with R as well using the package [RODBC](https://cran.r-project.org/web/packages/RODBC/index.html). This package enables the link in between R and the (remote) database.

```{r, warning = FALSE, message = FALSE}
library(RODBC)
```

For Windows users, the most important element is to know the so-called `DSN` (i.e. a registered Data Source Name). Actually, it is just the name of the database as it is known by your computer (and MS Access). The easiest way to check the `DSN` is to check the [*registered ODBC connections*](http://www.stata.com/support/faqs/data-management/configuring-odbc-win/) in the administrator tools menu. 

For Dutch-speaking Windows 7 users: 
> Kies in het Configuratiescherm van Windows de optie Systeembeheer > Gegevensbronnen (ODBC). De optie Systeembeheer verschijnt in de categorie Systeem en onderhoud.

You should see a list of something similar to the list underneath, with the names of the available DSN names enlisted:
![odbc-connecties](../img/odbc_gegevensbron.png)

An alternative way to check the DSN name of a database already working on with Access, is to check the DSN inside MS Access (in dutch, check menu item *Koppelingsbeheer*):

![access-dsn](../img/access_dsn.png)

For example, the DSN name `UserFlora` or `Cydonia-prd` can be used to query the Flora database and extract data from it with similar queries to the one used in MSAccess. First of all, the connection with the database need to be established, by using the `odbcConnect` function, providing the DSN name as argument:

```{r}
#my_connection <- odbcConnect("UserFlora")
my_connection <- odbcDriverConnect("Driver={ODBC Driver 13 for SQL Server};Server=inbosql04.inbo.be;Database=NBNData_IPT;Trusted_Connection=yes;")
```

Once this connection is sucessfully established, the database can be queried. 

## Get a complete table from the databse

The function `sqlFetch` can be used to load an entire table from a database. For example, to extract the `tblTaxon` table from the flora database:

```{r}
taxa_info <- sqlFetch(my_connection, "dbo.taxon_list")
```

with the connection `my_connection` made earlier is used as the first argument, the table name is the second argument.

**Remark:** If you have no idea about the size of the table you're trying to load from the database, this could be rather tricky and cumbersome. Hence, it is probably better to only extract a portion of the table using a query.

## Execute a query to the database

The function `sqlQuery` provides more flexibilty as it can be used to try any SQL-query on the database. A complete introduction to the SQL language is out of scope here. We will focus on the application and the reusage of a query.

# TODO

## Create and use query templates

When you regularly use similar queries, with some minimal alterations, you do not want to copy/paste each time the entire query. It is prone to errors and you're script will become verbose. It is advisable to create query *templates*, that can be used wihtin the `sqlQuery` function. 

# TODO


#-------------------------------------------------


```{r}
#my_connection <- odbcConnect("D0021_00_userFlora")

```


